pipeline {
    agent any

    options { skipDefaultCheckout() }

     stages {
        stage('Get Code') {
            steps {
                // Obtener código del repo
                git 'https://github.com/mmuniz-unir/helloworld.git'
	            echo WORKSPACE
				echo 'marc muñiz'
                bat 'dir'
                stash name:'code', includes:'**'
            }
        }
            
        stage('Tests')
        {
            parallel
            {
                stage('Unit') {
                    agent {label 'agent1'}
                    steps {
                        catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {
                            unstash name:'code'
                            sh '''
                                ls -la
                                export PYTHONPATH=${WORKSPACE}
                                /home/jenkins/.local/bin/pytest --junitxml=result-unit.xml test/unit
                            '''
                            stash name:'unit-res', includes:'result-unit.xml'
                       }
                    }
                }   
                
                
                stage('Rest') {
                    agent {label 'agent2'}
                    steps {
                      catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {
                        unstash name:'code'
                        sh '''
                            export FLASK_APP=app/api.py                          
                            /home/jenkins/.local/bin/flask run &

                            sleep 4

                            java -jar /home/agent/wiremock/wiremock-jre8-standalone-2.35.0.jar --port 9090 --root-dir /home/agent/wiremock &
                            export PYTHONPATH=${WORKSPACE}
                            
                            sleep 15
                            
                            /home/jenkins/.local/bin/pytest --junitxml=result-rest.xml test/rest
                        '''
                      }
                      stash name:'rest-res', includes:'result-rest.xml'
                    }    
                }                
                
            }
        }

        stage('Static'){
            agent {label 'agent2'}
            steps {
                unstash name:'code'
                sh '''
                    /home/jenkins/.local/bin/flake8 --format=pylint --exit-zero app >flake8.out

                '''

                recordIssues(
                tools: [flake8(name: 'Flake8', pattern: 'flake8.out')],
                qualityGates: [
                [threshold: 8,  type: 'TOTAL', unstable: true],
                [threshold: 10, type: 'TOTAL', unstable: false]
                ]
                )

            }

        }
         stage('Security Test'){
            agent {label 'agent1'}
            steps {
                unstash name:'code'

                sh '''
                    /home/jenkins/.local/bin/bandit --exit-zero -r . -f custom --msg-template "{abspath}:{line}: [{test_id}, ] {msg}" > bandit-pylint.out

                '''  
                recordIssues tools: [pyLint(name: 'Bandit', pattern: 'bandit-pylint.out',)], qualityGates: [[threshold: 1, type: 'TOTAL', unstable: true], [threshold: 2, type: 'TOTAL', unstable: false]]               
             }

         }

    //     stage('Performance'){

    //         steps {

                
                 
    //         }

    //     }

    //     stage('Coverage'){

    //         steps {

                
                 
    //         }

    //    }

      }


}    
