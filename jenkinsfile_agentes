pipeline {
    agent any

    options { skipDefaultCheckout() }

     stages {
        stage('Get Code') {
            agent {label 'windows'}
            steps {
                // Obtener cÃ³digo del repo
                git 'https://github.com/mmuniz-unir/helloworld.git'
                bat '''
                    whoami
                    hostname
                    echo WORKSPACE=%WORKSPACE%
                    dir
                '''
                stash name:'code', includes:'**'
            }
        }
            
        stage('Tests')
        {
            parallel
            {
                stage('Unit') {
                    agent {label 'Linux'}
                    steps {
                        catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {
                            unstash name:'code'
                            sh '''
                                whoami
                                hostname
                                echo WORKSPACE=$WORKSPACE
                                ls -la
                                export PYTHONPATH=${WORKSPACE}
                                /home/jenkins/.local/bin/pytest --junitxml=result-unit.xml test/unit
                            '''
                            stash name:'unit-res', includes:'result-unit.xml'
                       }
                    }
                }   
                
                
                stage('Rest') {
                    agent {label 'Linux'}
                    steps {
                      catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {
                        unstash name:'code'
                        sh '''
                            whoami
                            hostname
                            echo WORKSPACE=$WORKSPACE
                            export FLASK_APP=app/api.py                          
                            /home/jenkins/.local/bin/flask run &

                            sleep 4

                            java -jar /home/agent/wiremock/wiremock-jre8-standalone-2.35.0.jar --port 9090 --root-dir /home/agent/wiremock &
                            export PYTHONPATH=${WORKSPACE}
                            
                            sleep 10
                            
                            /home/jenkins/.local/bin/pytest --junitxml=result-rest.xml test/rest
                        '''
                      }
                      stash name:'rest-res', includes:'result-rest.xml'
                    }    
                }                
                
            

        stage('Static'){
            agent {label 'Linux'}
            steps {
                catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {
                unstash name:'code'
                sh '''
                    whoami
                    hostname
                    echo WORKSPACE=$WORKSPACE
                    /home/jenkins/.local/bin/flake8 --format=pylint --exit-zero app >flake8.out

                '''

                recordIssues(
                tools: [flake8(name: 'Flake8', pattern: 'flake8.out')],
                qualityGates: [
                [threshold: 8,  type: 'TOTAL', unstable: true],
                [threshold: 10, type: 'TOTAL', unstable: false]
                ]
                )

            }
            }

        }
         stage('Security Test'){
            agent {label 'Linux'}
            steps {

                catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {

                unstash name:'code'

                sh '''
                    whoami
                    hostname
                    echo WORKSPACE=$WORKSPACE
                    /home/jenkins/.local/bin/bandit --exit-zero -r . -f custom --msg-template "{abspath}:{line}: [{test_id}, ] {msg}" > bandit-pylint.out

                '''  
                recordIssues tools: [pyLint(name: 'Bandit', pattern: 'bandit-pylint.out',)], qualityGates: [[threshold: 2, type: 'TOTAL', unstable: true], [threshold: 4, type: 'TOTAL', unstable: false]]               
             }

         }
         }

        }

    }

         stage('Performance'){
             agent {label 'windows'}
             steps {

                catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {

                unstash name:'code'

                bat '''
                    whoami
                    hostname
                    echo WORKSPACE=$WORKSPACE
                    set FLASK_APP=app\\api.py
                    start flask run
                    ping 127.0.0.1 -n 7 >nul
                    C:\\jmeter\\apache-jmeter-5.6.3\\bin\\jmeter -n -t test\\jmeter\\test-plan.jmx -f -l performance.jtl

                '''

                perfReport sourceDataFiles: 'performance.jtl'
                 
             }

             }

         }

         stage('Coverage'){
            agent {label 'windows'}
             steps {

                catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {

                unstash name: 'code'

                bat '''
                    whoami
                    hostname
                    echo WORKSPACE=%WORKSPACE%
                    set PYTHONPATH=%WORKSPACE%
                    coverage run --source=app --omit=app\\__init__.py,app\\api.py -m pytest test\\unit
                    coverage xml

                '''
                recordCoverage qualityGates: [
                    [criticality: 'ERROR', integerThreshold: 85, metric: 'LINE', threshold: 85.0], 
                    [criticality: 'NOTE', integerThreshold: 95, metric: 'LINE', threshold: 95.0], 
                    [criticality: 'ERROR', integerThreshold: 80, metric: 'BRANCH', threshold: 80.0], 
                    [criticality: 'NOTE', integerThreshold: 90, metric: 'BRANCH', threshold: 90.0]
                    ], tools: [
                        [parser: 'COBERTURA', pattern: 'coverage.xml']]
                 
             }

             }

        }

      }


}    
